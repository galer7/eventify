org: galer7
app: aws-node-project
service: aws-node-project

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs16.x
  stage: development
  region: us-east-1
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - ses:SendEmail
            - ses:SendRawEmail
          Resource: '*'

stepFunctions:
  stateMachines:
    reminderMachine:
      definition:
        StartAt: FirstState
        States:
          FirstState:
            Type: Task
            Resource:
              Fn::GetAtt: [sendReminder, Arn]
            Next: wait_using_timestamp_path
          wait_using_timestamp_path:
            Type: Wait
            TimestampPath: "$.expirydate"
            Next: FinalState
          FinalState:
            Type: Task
            Resource:
              Fn::GetAtt: [sendReminder, Arn]
            End: true
      events:
        - http:
            path: /set-reminder
            method: post

functions:
  sendReminder:
    handler: handler.sendReminder
    events:
      - http:
          path: /send-reminder
          method: post

plugins:
  - serverless-bundle
  - serverless-step-functions
